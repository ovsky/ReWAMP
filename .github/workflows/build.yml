name: Build and Release

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      build_platforms:
        description: "Select platforms to build"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - windows-only
          - linux-only
      skip_tests:
        description: "Skip running tests"
        required: false
        default: false
        type: boolean
      run_release:
        description: "Also create a GitHub Release from this run"
        required: false
        default: false
        type: boolean
      release_tag:
        description: "Tag to use when creating a manual release (e.g., v1.2.3)"
        required: false
        type: string

jobs:
  build:
    strategy:
      matrix:
        include:
          # Windows AMD64 (64-bit Intel/AMD)
          - os: windows-latest
            goos: windows
            goarch: amd64
            artifact: rewamp-windows-amd64
            binary: rewamp-windows-amd64.exe
            build-flags: -ldflags="-H windowsgui -s -w"
            platform: windows
            cache-path: |
              ~\AppData\Local\go-build
              ~\go\pkg\mod

          # Windows 386 (32-bit Intel/AMD)
          - os: windows-latest
            goos: windows
            goarch: "386"
            artifact: rewamp-windows-386
            binary: rewamp-windows-386.exe
            build-flags: -ldflags="-H windowsgui -s -w"
            platform: windows
            cache-path: |
              ~\AppData\Local\go-build
              ~\go\pkg\mod

          # Windows ARM64 (Surface Pro X, Windows on ARM)
          - os: windows-latest
            goos: windows
            goarch: arm64
            artifact: rewamp-windows-arm64
            binary: rewamp-windows-arm64.exe
            build-flags: -ldflags="-H windowsgui -s -w"
            platform: windows
            cache-path: |
              ~\AppData\Local\go-build
              ~\go\pkg\mod

          # Linux AMD64 (64-bit Intel/AMD)
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            artifact: rewamp-linux-amd64
            binary: rewamp-linux-amd64
            build-flags: -ldflags="-s -w"
            platform: linux
            cache-path: |
              ~/.cache/go-build
              ~/go/pkg/mod

          # Linux ARM64 (Raspberry Pi 4+, ARM servers)
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            artifact: rewamp-linux-arm64
            binary: rewamp-linux-arm64
            build-flags: -ldflags="-s -w"
            platform: linux
            cache-path: |
              ~/.cache/go-build
              ~/go/pkg/mod
    runs-on: ${{ matrix.os }}
    if: >-
      ${{ github.event_name != 'workflow_dispatch' ||
          github.event.inputs.build_platforms == 'all' ||
          (github.event.inputs.build_platforms == 'windows-only' && matrix.platform == 'windows') ||
          (github.event.inputs.build_platforms == 'linux-only' && matrix.platform == 'linux') }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          check-latest: true

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ${{ matrix.cache-path }}
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Linux build deps (CGO + GTK)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libgtk-3-dev libayatana-appindicator3-dev

      - name: Download dependencies
        run: go mod download

      - name: Locate main package directory (Linux/macOS)
        if: runner.os != 'Windows'
        id: find_nix
        shell: bash
        run: |
          set -euo pipefail
          preferred="$GITHUB_WORKSPACE/cmd/rewamp"
          if [ -d "$preferred" ]; then
            echo "main_dir=$preferred" | tee -a "$GITHUB_OUTPUT"
            exit 0
          fi
          dirs=$(go list -f '{{if eq .Name "main"}}{{.Dir}}{{end}}' ./... | sed '/^$/d')
          main_dir=$(echo "$dirs" | grep -E '/cmd/rewamp$' || true)
          if [ -z "$main_dir" ]; then
            main_dir=$(echo "$dirs" | head -n1)
          fi
          echo "main_dir=$main_dir" | tee -a "$GITHUB_OUTPUT"
          echo "Main package dir: $main_dir"

      - name: Locate main package directory (Windows)
        if: runner.os == 'Windows'
        id: find_win
        shell: pwsh
        run: |
          $preferred = Join-Path $env:GITHUB_WORKSPACE 'cmd' 'rewamp'
          if (Test-Path $preferred) { $dir = $preferred }
          else {
            $tpl = "{{if eq .Name \"main\"}}{{.Dir}}{{end}}"
            $dirsText = & go list -f $tpl ./...
            $dirs = $dirsText -split "`n" | Where-Object { $_ }
            $dir = $dirs | Where-Object { $_ -match '\\cmd\\rewamp$' } | Select-Object -First 1
            if (-not $dir) { $dir = $dirs | Select-Object -First 1 }
          }
          Add-Content -Path $env:GITHUB_OUTPUT -Value "main_dir=$dir"
          Write-Host "Main package dir: $dir"

      - name: Export MAIN_DIR (nix)
        if: runner.os != 'Windows'
        shell: bash
        run: echo "MAIN_DIR=${{ steps.find_nix.outputs.main_dir }}" >> "$GITHUB_ENV"

      - name: Export MAIN_DIR (win)
        if: runner.os == 'Windows'
        shell: pwsh
        run: echo "MAIN_DIR=${{ steps.find_win.outputs.main_dir }}" >> $env:GITHUB_ENV

      - name: Run tests
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_tests != 'true' }}
        run: go test -v ./...

      - name: Run go vet
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_tests != 'true' }}
        run: go vet ./...

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: go build -C "${{ env.MAIN_DIR }}" ${{ matrix.build-flags }} -o "${{ github.workspace }}/${{ matrix.binary }}" .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.binary }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_release == 'true') }}
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts

      - name: Create Release (tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/rewamp-windows-amd64/rewamp-windows-amd64.exe
            artifacts/rewamp-windows-386/rewamp-windows-386.exe
            artifacts/rewamp-windows-arm64/rewamp-windows-arm64.exe
            artifacts/rewamp-linux-amd64/rewamp-linux-amd64
            artifacts/rewamp-linux-arm64/rewamp-linux-arm64
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release (manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          files: |
            artifacts/rewamp-windows-amd64/rewamp-windows-amd64.exe
            artifacts/rewamp-windows-386/rewamp-windows-386.exe
            artifacts/rewamp-windows-arm64/rewamp-windows-arm64.exe
            artifacts/rewamp-linux-amd64/rewamp-linux-amd64
            artifacts/rewamp-linux-arm64/rewamp-linux-arm64
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
